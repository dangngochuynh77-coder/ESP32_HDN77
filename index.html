<!DOCTYPE html>
<html>
<head>
    <title>Trang nạp ESP32 Tự Động HĐN77</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        h1 { color: #333; }
        button { background: #007BFF; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        pre { background: #eee; border: 1px solid #ddd; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
        
        /* Ẩn các thành phần chọn file */
        #firmwareFile, #selectFileButton {
            display: none;
        }
    </style>
</head>
<body>

    <h1>Trang nạp Firmware ESP32 Tự Động</h1>
    
    <button id="connectButton">1. Kết nối ESP32</button>
    <input type="file" id="firmwareFile" accept=".bin">
    <button id="selectFileButton">Chọn File (.bin)</button>
    <button id="flashButton" disabled>2. Nạp Firmware</button>

    <h3>Log:</h3>
    <pre id="log"></pre>

    <script src="bundle.js"></script>
    
    <script>
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! THAY THẾ LINK NÀY BẰNG LINK "RAW" FILE .BIN CỦA BẠN !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const firmwareUrl = 'https://github.com/dangngochuynh77-coder/ESP32_HDN77/raw/refs/heads/main/PuppyFull_soxo.bin';

        // Lấy các phần tử DOM
        const connectButton = document.getElementById('connectButton');
        const flashButton = document.getElementById('flashButton');
        const logElement = document.getElementById('log');

        let device = null;
        let esploader = null;
        let fileContent = null; 
        let espConnected = false;
        
        function log(message) {
            logElement.textContent += message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- HÀM TẢI FIRMWARE (ĐÃ SỬA LỖI 2: Ẩn link log) ---
        async function fetchFirmware() {
            // Đã ẩn link URL khỏi log
            log("Đang chuẩn bị file firmware..."); 
            try {
                const response = await fetch(firmwareUrl);
                if (!response.ok) {
                    // Đã ẩn gợi ý "Link 'Raw'"
                    throw new Error(`Lỗi HTTP! Trạng thái: ${response.status} (Không tìm thấy file firmware)`);
                }
                fileContent = await response.arrayBuffer(); 
                log(`Tải firmware thành công! Kích thước: ${fileContent.byteLength} bytes`);
                
                if (espConnected) {
                    flashButton.disabled = false;
                    log("Thiết bị và firmware đã sẵn sàng. Nhấn 'Nạp Firmware'.");
                } else {
                    log("Firmware đã sẵn sàng, đang chờ kết nối thiết bị...");
                }

            } catch (e) {
                log("LỖI TẢI FIRMWARE: " + e.message);
                // Đã ẩn gợi ý "Link 'Raw'"
            }
        }
        
        // 1. Sự kiện nhấn nút KẾT NỐI
        connectButton.onclick = async () => {
            try {
                // Dòng này sẽ gọi thư viện bundle.js
                // Nếu bundle.js tải thành công, "new ESPLoader" sẽ không còn lỗi
                device = await navigator.serial.requestPort({});
                esploader = new ESPLoader({
                    device: device,
                    baudrate: 115200, 
                    log: log 
                });

                log("Đang kết nối...");
                await esploader.connect();
                log("Đã kết nối thành công!");
                log("Chip: " + esploader.chipName);
                log("MAC: " + esploader.macAddr());

                espConnected = true;
                connectButton.disabled = true;

                if (fileContent) {
                    flashButton.disabled = false;
                    log("Thiết bị và firmware đã sẵn sàng. Nhấn 'Nạp Firmware'.");
                } else {
                    log("Đang chờ tải firmware...");
                }

            } catch (e) {
                log("Lỗi kết nối: " + e.message);
                espConnected = false;
            }
        };

        // 2. Sự kiện nhấn nút NẠP FIRMWARE
        flashButton.onclick = async () => {
            if (!esploader || !fileContent) {
                log("Lỗi: Chưa kết nối hoặc firmware chưa được tải.");
                return;
            }

            try {
                log("Bắt đầu nạp... (Có thể mất vài phút)");
                flashButton.disabled = true;

                await esploader.write_flash(
                    [{ data: fileContent, address: 0x1000 }],
                    false 
                );

                log("NẠP THÀNH CÔNG!");
                log("Đang khởi động lại thiết bị...");
                
                await esploader.hard_reset();
                await esploader.disconnect();
                
                connectButton.disabled = false;
                flashButton.disabled = true;
                espConnected = false;

            } catch (e) {
                log("LỖI NẠP FIRMWARE: " + e.message);
                flashButton.disabled = false;
            }
        };

        // --- TỰ ĐỘNG CHẠY KHI TẢI TRANG ---
        fetchFirmware(); 

    </script>
</body>
</html>
