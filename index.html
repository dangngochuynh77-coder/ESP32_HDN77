<!DOCTYPE html>
<html>
<head>
    <title>Trang nạp ESP32 Tự Động</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        h1 { color: #333; }
        button { background: #007BFF; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        pre { background: #eee; border: 1px solid #ddd; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
        #firmwareFile, #selectFileButton { display: none; }
    </style>
</head>
<body>

    <h1>Trang nạp Firmware Puppy Tự Động HĐN77</h1>
    
    <button id="connectButton">1. Kết nối ESP32</button>
    <input type="file" id="firmwareFile" accept=".bin">
    <button id="selectFileButton">Chọn File (.bin)</button>
    <button id="flashButton" disabled>2. Nạp Firmware</button>

    <h3>Log:</h3>
    <pre id="log"></pre>

    <script>
        // Link "Raw" file .bin của bạn
        const firmwareUrl = 'https://raw.githubusercontent.com/dangngochuynh77-coder/ESP32_HDN77/main/PuppyFull_soxo.bin';

        // Lấy các phần tử DOM
        const connectButton = document.getElementById('connectButton');
        const flashButton = document.getElementById('flashButton');
        const logElement = document.getElementById('log');

        let device = null;
        let esploader = null;
        let fileContent = null; 
        let espConnected = false;
        
        // Lưu trữ Class ESPLoader
        let ESPLoader;

        function log(message) {
            logElement.textContent += message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- HÀM TẢI FIRMWARE ---
        async function fetchFirmware() {
            log("Đang chuẩn bị file firmware..."); 
            try {
                const response = await fetch(firmwareUrl);
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP! Trạng thái: ${response.status} (Không tìm thấy file firmware)`);
                }
                fileContent = await response.arrayBuffer(); 
                log(`Tải firmware thành công! Kích thước: ${fileContent.byteLength} bytes`);
                
                if (espConnected) {
                    flashButton.disabled = false;
                    log("Thiết bị và firmware đã sẵn sàng. Nhấn 'Nạp Firmware'.");
                } else {
                    log("Firmware đã sẵn sàng, đang chờ kết nối thiết bị...");
                }

            } catch (e) {
                log("LỖI TẢI FIRMWARE: " + e.message);
            }
        }
        
        // --- SỰ KIỆN NHẤN NÚT KẾT NỐI ---
        connectButton.onclick = async () => {
            
            // BƯỚC 1: Tải và Import module 'bundle.js'
            if (!ESPLoader) {
                try {
                    log("Đang tải công cụ nạp...");
                    const module = await import('./bundle.js'); 
                    ESPLoader = module.ESPLoader; 
                    
                    if (!ESPLoader) {
                        throw new Error("Không tìm thấy class ESPLoader trong file bundle.js.");
                    }
                    log("Tải công cụ nạp thành công.");
                } catch (e) {
                    log("LỖI TẢI CÔNG CỤ NẠP (bundle.js): " + e.message);
                    return; 
                }
            }

            // BƯỚC 2: Chạy code kết nối
            try {
                device = await navigator.serial.requestPort({});
                
                esploader = new ESPLoader({
                    port: device,
                    baudrate: 115200, 
                    log: log 
                });

                log("Đang kết nối...");
                await esploader.connect();
                log("Đã kết nối thành công!");

                // ===================================================================
                // SỬA LỖI Ở ĐÂY: Đã đổi sang hàm/thuộc tính mới
                // ===================================================================
                const mac = await esploader.chip.readMac(esploader);
                log("Chip: " + esploader.chip.CHIP_NAME);
                log("MAC: " + mac);
                // ===================================================================

                espConnected = true;
                connectButton.disabled = true;

                if (fileContent) {
                    flashButton.disabled = false;
                    log("Thiết bị và firmware đã sẵn sàng. Nhấn 'Nạp Firmware'.");
                } else {
                    log("Đang chờ tải firmware...");
                }

            } catch (e) {
                log("Lỗi kết nối: " + e.message);
                espConnected = false;
            }
        };

        // --- HÀM NẠP FIRMWARE (Không thay đổi) ---
        flashButton.onclick = async () => {
            if (!esploader || !fileContent) {
                log("Lỗi: Chưa kết nối hoặc firmware chưa được tải.");
                return;
            }

            try {
                log("Bắt đầu nạp... (Có thể mất vài phút)");
                flashButton.disabled = true;

                // ===================================================================
                // SỬA LỖI Ở ĐÂY: Thêm tham số 'true' để báo cho stub biết đây là file nén
                // esploader.write_flash(..., ..., ..., true)
                // ===================================================================
                await esploader.write_flash(
                    [{ data: fileContent, address: 0x1000 }],
                    false, // Mặc định là 'false' (không xóa)
                    false, // Mặc định là 'false' (không xác minh)
                    true   // **Quan trọng: true = file nén**
                );

                log("NẠP THÀNH CÔNG!");
                log("Đang khởi động lại thiết bị...");
                
                await esploader.hard_reset();
                await esploader.disconnect();
                
                connectButton.disabled = false;
                flashButton.disabled = true;
                espConnected = false;

            } catch (e) {
                log("LỖI NẠP FIRMWARE: " + e.message);
                flashButton.disabled = false;
            }
        };

        // --- TỰ ĐỘNG CHẠY KHI TẢI TRANG ---
        fetchRoomware(); 

    </script>
</body>
</html>
